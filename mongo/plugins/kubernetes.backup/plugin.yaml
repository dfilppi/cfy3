plugins:
  kubernetes:
    executor: central_deployment_agent
    source: /home/vagrant/cfy3/mongo/plugins/kubernetes

node_types:
  cloudify.kubernetes.Base:
    derived_from: cloudify.nodes.Compute
    properties:
      install_agent:
        default: false
      ssh_keyfilename:
        description: file name that holds ssh key for passwordless operation
        default: ''
      ssh_username:
        description: ssh user
      ssh_password:
        description: ssh password when not using passwordless operation
        default: ''
      ssh_port:
        description: ssh port.  defaults to 22
        default: 22
      

  ##########################################
  # Represents a master/node
  ##########################################
  cloudify.kubernetes.Master:
    derived_from: cloudify.kubernetes.Base
    properties:
      master_port:
        default: 8080
      install:
        default: True
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          implementation: fabric.fabric_plugin.tasks.run_module_task
          inputs: 
            task_mapping:
              default: kube_plugin.start-master-ubuntu14-tasks.start_master
            fabric_env:
              default:
                user: { get_property: [SELF,ssh_username]}
                password: { get_property: [SELF,ssh_password]}
                key_filename: { get_property: [SELF,ssh_keyfilename]}
                host_string: { concat: [ {get_property: [ SELF, ssh_username]},'@',{ get_property: [SELF, ip] }] }
                port: { get_property: [SELF,ssh_port]}

  ##########################################
  # Represents a minion/node
  ##########################################
  cloudify.kubernetes.Node:
    derived_from: cloudify.kubernetes.Base
    properties:
      master_ip:
        default: ''
      master_port:
        default: 0
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          implementation: fabric.fabric_plugin.tasks.run_module_task
          inputs: 
            task_mapping:
              default: kube_plugin.start-node-ubuntu14-tasks.start_node
            task_name:
              default: start_node
            fabric_env:
              default:
                user: { get_property: [SELF,ssh_username]}
                password: { get_property: [SELF,ssh_password]}
                key_filename: { get_property: [SELF,ssh_keyfilename]}
                host_string: { concat: [ {get_property: [ SELF, ssh_username]},'@',{ get_property: [SELF, ip] }] }
                port: { get_property: [SELF,ssh_port]}
    
  ##########################################
  # Represents a kubernetes service
  ##########################################
  cloudify.kubernetes.Microservice:
    derived_from: cloudify.nodes.Container
    properties:
      install_agent:
        default: false
      name:
        description: the name of the service
      image:
        description: the image to run
      port:
        description: the port for the service
      target_port:
        description: the target port to map
        default: {get_property: [SELF,port]}
      protocol:
        description: the service protocol { TCP|UDP }  TCP default
        default: TCP
      replicas:
        description: the number of instances to run
        default: 1
      run_overrides:
        description: json overrides for kubectl run
        default: ''
      expose_overrides:
        description: json overrides for kubectl expose
        default: ''
      config:
        description: key/values in kubernetes format
        default: {}
    interfaces:
      cloudify.interfaces.lifecycle:
        start:
          implementation: kube_plugin.tasks.kube_run_expose


relationships:
  cloudify.kubernetes.relationships.connected_to_master:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        postconfigure:
          implementation: kubernetes.kube_plugin.tasks.connect_master

workflows:
  kube_run:
    mapping: kubernetes.kube_plugin.workflows.kube_run
    parameters:
      master:
        description: name of master node
      name:
        description: name of the app
      image:
        description: image to run
      port:
        description: port to open
        default: -1
      replicas:
        description: number of replicas
        default: 1
      dry_run:
        description: don't actually do anything
        default: False
      overrides:
        description: json overrides
        default: ''

  kube_expose:
    mapping: kubernetes.kube_plugin.workflows.kube_expose
    parameters:
      master:
        description: name of master node
      name:
        description: name of the resource to expose
      resource:
        description: type of the resource to be exposed
      protocol:
        description: protocol to expose (TCP|UDP)
        default: TCP
      port:
        description: the port to be exposed
      target_port:
        description: container port to expose
        default: -1
      service_name:
        description: name of the newly created object
        default: ''
      overrides:
        description: json overrides
        default: ''

  kube_stop:
    mapping: kubernetes.kube_plugin.workflows.kube_stop
    parameters:
      master:
        description: name of master node
      name:
        description: name of the resource to stop
      resource:
        description: type of the resource to be stopped
      all:
        description: stop all
        default: False
  
  kube_delete:
    mapping: kubernetes.kube_plugin.workflows.kube_delete
    parameters:
      master:
        description: name of master node
      name:
        description: name of the resource to delete
      resource:
        description: type of the resource to be deleted
      all:
        description: stop all
        default: False
      
